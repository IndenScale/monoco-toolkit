# Courier CLI è®¾è®¡

**Version**: 1.1.0
**Status**: Draft
**Related**: FEAT-0191

---

## 1. æ¦‚è¿°

Courier CLI æ˜¯ Courier æœåŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†çš„å”¯ä¸€æ¥å£ã€‚å®ƒä»…è´Ÿè´£æœåŠ¡çš„**å¯åŠ¨ã€åœæ­¢å’Œç›‘æ§**ï¼Œä¸è´Ÿè´£ Mail å¤„ç†ã€‚æ‰€æœ‰ Mail æ“ä½œé€šè¿‡ `mailbox` å‘½ä»¤å®Œæˆã€‚

### 1.1 è®¾è®¡åŸåˆ™

1. **å•ä¸€èŒè´£**: Courier CLI åªç®¡ç†æœåŠ¡è¿›ç¨‹
2. **ä¸æ•°æ®åˆ†ç¦»**: Mail çŠ¶æ€ç®¡ç†æ˜¯ Courier æœåŠ¡çš„å†…éƒ¨èŒè´£ï¼ŒCLI ä¸ç›´æ¥å¹²é¢„
3. **ç®€å•ç›´æ¥**: å‘½ä»¤è¯­ä¹‰æ¸…æ™°ï¼Œè¡Œä¸ºå¯é¢„æµ‹
4. **å¿«é€Ÿå¤±è´¥**: æ“ä½œå¤±è´¥ç«‹å³è¿”å›é”™è¯¯ï¼Œä¸é˜»å¡

---

## 2. å‘½ä»¤æ¦‚è§ˆ

```
monoco courier
â”œâ”€â”€ start         # å¯åŠ¨ Courier æœåŠ¡
â”œâ”€â”€ stop          # åœæ­¢ Courier æœåŠ¡ï¼ˆä¼˜é›…å…³é—­ï¼‰
â”œâ”€â”€ restart       # é‡å¯ Courier æœåŠ¡
â”œâ”€â”€ kill          # å¼ºåˆ¶åœæ­¢ Courier æœåŠ¡ï¼ˆä¸ä¼˜é›…ï¼‰
â”œâ”€â”€ status        # æŸ¥çœ‹æœåŠ¡çŠ¶æ€
â””â”€â”€ logs          # æŸ¥çœ‹æœåŠ¡æ—¥å¿—
```

**æ³¨æ„**: Courier CLI **æ²¡æœ‰** `send`ã€`archive`ã€`config` ç­‰å‘½ä»¤ã€‚è¿™äº›åŠŸèƒ½é€šè¿‡ `mailbox` å‘½ä»¤æˆ– Courier æœåŠ¡è‡ªåŠ¨å®Œæˆã€‚

---

## 3. æœåŠ¡ç®¡ç†å‘½ä»¤

### 3.1 `courier start`

å¯åŠ¨ Courier å®ˆæŠ¤è¿›ç¨‹ã€‚

```bash
# åŸºæœ¬ç”¨æ³•
monoco courier start                          # åå°å¯åŠ¨æœåŠ¡
monoco courier start --foreground             # å‰å°å¯åŠ¨ï¼ˆè°ƒè¯•ç”¨ï¼‰
monoco courier start --debug                  # è°ƒè¯•æ¨¡å¼ï¼ˆè¯¦ç»†æ—¥å¿—ï¼‰

# é…ç½®é€‰é¡¹
monoco courier start --config /path/to/config.yaml  # æŒ‡å®šé…ç½®æ–‡ä»¶
```

**è¡Œä¸º**:
- åˆ›å»º PID æ–‡ä»¶ `.monoco/run/courier.pid`
- å¯åŠ¨æ—¥å¿—å†™å…¥ `.monoco/log/courier.log`
- å¯åŠ¨ HTTP API æœåŠ¡ï¼ˆé»˜è®¤ç«¯å£ 8080ï¼‰
- åˆå§‹åŒ–æ‰€æœ‰å¯ç”¨çš„é€‚é…å™¨
- å¼€å§‹ç›‘å¬ Webhook å’Œè½®è¯¢

**è¿”å›ç **:
- `0`: å¯åŠ¨æˆåŠŸ
- `1`: å¯åŠ¨å¤±è´¥
- `2`: æœåŠ¡å·²åœ¨è¿è¡Œ

---

### 3.2 `courier stop`

ä¼˜é›…åœ°åœæ­¢ Courier æœåŠ¡ã€‚

```bash
# åŸºæœ¬ç”¨æ³•
monoco courier stop                           # å‘é€åœæ­¢ä¿¡å·
monoco courier stop --timeout 30              # ç­‰å¾…30ç§’åå¼ºåˆ¶åœæ­¢

# é€‰é¡¹
monoco courier stop --wait                    # é˜»å¡ç›´åˆ°æœåŠ¡åœæ­¢
```

**è¡Œä¸º**:
1. å‘é€ SIGTERM ä¿¡å·ç»™ Courier è¿›ç¨‹
2. Courier å¼€å§‹ä¼˜é›…å…³é—­ï¼š
   - åœæ­¢æ¥æ”¶å¤–éƒ¨è¾“å…¥ï¼ˆWebhook è¿”å› 503ï¼‰
   - å®Œæˆè¿›è¡Œä¸­çš„å‘é€ä»»åŠ¡
   - ç­‰å¾…å·²è®¤é¢† Mail è¶…æ—¶æˆ–å®Œæˆ
   - å…³é—­é€‚é…å™¨è¿æ¥
   - æ¸…ç†ä¸´æ—¶æ–‡ä»¶
3. å¦‚æœåœ¨ timeout å†…æœªå®Œæˆï¼Œå‘é€ SIGKILL

**æ³¨æ„**: ä¼˜é›…åœæ­¢å¯èƒ½è¾ƒæ…¢ï¼Œä½†ä¸ä¼šä¸¢å¤± Mailã€‚

---

### 3.3 `courier restart`

é‡å¯ Courier æœåŠ¡ã€‚

```bash
# åŸºæœ¬ç”¨æ³•
monoco courier restart                        # åœæ­¢åé‡æ–°å¯åŠ¨
monoco courier restart --force                # å¦‚æœåœæ­¢å¤±è´¥ï¼Œå¼ºåˆ¶é‡å¯
```

**è¡Œä¸º**:
- ç­‰åŒäº `stop` + `start`
- ä¿æŒé…ç½®ä¸å˜

---

### 3.4 `courier kill`

å¼ºåˆ¶åœæ­¢ Courier æœåŠ¡ã€‚

```bash
# åŸºæœ¬ç”¨æ³•
monoco courier kill                           # ç«‹å³å¼ºåˆ¶åœæ­¢
monoco courier kill --signal INT              # å‘é€ç‰¹å®šä¿¡å·ï¼ˆé»˜è®¤ SIGKILLï¼‰
```

âš ï¸ **è­¦å‘Š**:
- ç«‹å³ç»ˆæ­¢è¿›ç¨‹ï¼Œ**ä¸æ‰§è¡Œæ¸…ç†é€»è¾‘**
- å¯èƒ½å¯¼è‡´ï¼š
  - å†…å­˜ä¸­çš„é”çŠ¶æ€ä¸¢å¤±
  - å·²è®¤é¢† Mail çŠ¶æ€ä¸ç¡®å®š
  - å‘é€ä¸­çš„ Mail çŠ¶æ€ä¸ç¡®å®š
  - ä¸´æ—¶æ–‡ä»¶æ®‹ç•™
  - å¤–éƒ¨å¹³å°è¿æ¥å¼‚å¸¸

**ä½¿ç”¨åœºæ™¯**:
- æœåŠ¡æ— å“åº”ï¼Œæ­£å¸¸ stop æ— æ•ˆ
- éœ€è¦ç«‹å³é‡Šæ”¾èµ„æº
- ç´§æ€¥æƒ…å†µä¸‹å¿«é€Ÿæ¢å¤

**ä¸å»ºè®®ä½¿ç”¨åœºæ™¯**:
- æ­£å¸¸ç»´æŠ¤ï¼ˆè¯·ç”¨ `stop`ï¼‰
- å¯ä»¥ç­‰å¾…çš„ä»»åŠ¡å®Œæˆ

---

### 3.5 `courier status`

æŸ¥çœ‹ Courier æœåŠ¡çŠ¶æ€ã€‚

```bash
# åŸºæœ¬ç”¨æ³•
monoco courier status                         # æ˜¾ç¤ºæœåŠ¡çŠ¶æ€
monoco courier status --json                  # JSON æ ¼å¼è¾“å‡º
monoco courier status --watch                 # æŒç»­ç›‘æ§
```

**è¾“å‡ºç¤ºä¾‹**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Courier Service Status                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Service:     running                                             â”‚
â”‚ PID:         12345                                               â”‚
â”‚ Uptime:      2 hours 15 minutes                                  â”‚
â”‚ Version:     1.0.0                                               â”‚
â”‚ API:         http://localhost:8080                               â”‚
â”‚                                                                  â”‚
â”‚ Adapters:                                                        â”‚
â”‚   lark       ğŸŸ¢ connected     (webhook: 8080)                   â”‚
â”‚   email      ğŸŸ¢ connected     (poll: 30s)                       â”‚
â”‚   slack      âšª disabled                                         â”‚
â”‚                                                                  â”‚
â”‚ Metrics:                                                         â”‚
â”‚   Messages Received:  152                                        â”‚
â”‚   Messages Sent:      43                                         â”‚
â”‚   Messages Claimed:   2                                          â”‚
â”‚   Messages Pending:   5                                          â”‚
â”‚   Errors:             0                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**çŠ¶æ€è¯´æ˜**:
- ğŸŸ¢ `connected`: æ­£å¸¸è¿æ¥
- ğŸŸ¡ `connecting`: æ­£åœ¨è¿æ¥
- ğŸ”´ `error`: è¿æ¥é”™è¯¯
- âšª `disabled`: å·²ç¦ç”¨

---

### 3.6 `courier logs`

æŸ¥çœ‹ Courier æœåŠ¡æ—¥å¿—ã€‚

```bash
# åŸºæœ¬ç”¨æ³•
monoco courier logs                           # æ˜¾ç¤ºæœ€è¿‘100è¡Œ
monoco courier logs --follow                  # å®æ—¶è·Ÿè¸ª
monoco courier logs --lines 500               # æ˜¾ç¤ºæœ€è¿‘500è¡Œ

# è¿‡æ»¤
monoco courier logs --level error             # ä»…æ˜¾ç¤ºé”™è¯¯
monoco courier logs --adapter lark            # ä»…æ˜¾ç¤º lark é€‚é…å™¨æ—¥å¿—
monoco courier logs --since "1h"              # æœ€è¿‘1å°æ—¶
```

---

## 4. kill vs stop å¯¹æ¯”

| ç‰¹æ€§ | `stop` | `kill` |
|------|--------|--------|
| ä¿¡å· | SIGTERM | SIGKILL |
| ä¼˜é›…å…³é—­ | âœ… æ˜¯ | âŒ å¦ |
| ç­‰å¾…ä»»åŠ¡å®Œæˆ | âœ… æ˜¯ | âŒ å¦ |
| æ¸…ç†èµ„æº | âœ… æ˜¯ | âŒ å¦ |
| é”çŠ¶æ€ä¿å­˜ | âœ… æ˜¯ | âŒ ä¸¢å¤± |
| æ•°æ®ä¸¢å¤±é£é™© | ä½ | é«˜ |
| é€‚ç”¨åœºæ™¯ | æ­£å¸¸ç»´æŠ¤ | ç´§æ€¥æ¢å¤ |

---

## 5. å…¸å‹å·¥ä½œæµ

### 5.1 æ—¥å¸¸å¯åŠ¨æµç¨‹

```bash
# 1. æ£€æŸ¥çŠ¶æ€
monoco courier status

# 2. å¦‚æœæœªè¿è¡Œï¼Œå¯åŠ¨æœåŠ¡
monoco courier start

# 3. ç¡®è®¤å¯åŠ¨æˆåŠŸ
monoco courier status
```

### 5.2 æ•…éšœæ¢å¤æµç¨‹

```bash
# 1. æ£€æŸ¥çŠ¶æ€
monoco courier status
# Output: Service: error (adapter lark: connection timeout)

# 2. æŸ¥çœ‹é”™è¯¯æ—¥å¿—
monoco courier logs --level error --lines 50

# 3. å°è¯•ä¼˜é›…é‡å¯
monoco courier restart

# 4. å¦‚æœé‡å¯å¤±è´¥ï¼Œå¼ºåˆ¶åœæ­¢åå¯åŠ¨
monoco courier kill
monoco courier start
```

### 5.3 é…ç½®æ›´æ–°æµç¨‹

```bash
# 1. åœæ­¢æœåŠ¡
monoco courier stop

# 2. ç¼–è¾‘é…ç½®æ–‡ä»¶
vim .monoco/config/courier.yaml

# 3. å¯åŠ¨æœåŠ¡
monoco courier start
```

---

## 6. é”™è¯¯å¤„ç†

| é”™è¯¯åœºæ™¯ | å‘½ä»¤ | è¿”å›ç  | æç¤ºä¿¡æ¯ |
|----------|------|--------|----------|
| æœåŠ¡å·²åœ¨è¿è¡Œ | `start` | 2 | `Error: Courier is already running (PID: 12345)` |
| æœåŠ¡æœªè¿è¡Œ | `stop`/`kill`/`restart` | 1 | `Error: Courier is not running` |
| PID æ–‡ä»¶å­˜åœ¨ä½†è¿›ç¨‹ä¸å­˜åœ¨ | `start` | 1 | `Error: Stale PID file found, cleaning up...` |
| æƒé™ä¸è¶³ | `start` | 3 | `Error: Permission denied to write PID file` |
| ç«¯å£è¢«å ç”¨ | `start` | 4 | `Error: Port 8080 is already in use` |

---

## 7. ä¸ Mailbox CLI çš„å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent ç”¨æˆ·                                                  â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚    mailbox   â”‚      â”‚   courier    â”‚                    â”‚
â”‚  â”‚    list      â”‚      â”‚   start      â”‚                    â”‚
â”‚  â”‚    read      â”‚      â”‚   stop       â”‚  â—„â”€â”€ ä»…æœåŠ¡ç®¡ç†     â”‚
â”‚  â”‚    send      â”‚      â”‚   status     â”‚                    â”‚
â”‚  â”‚    claim â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
â”‚  â”‚    done   â”€â”€â”€â”¤      â”‚              â”‚                    â”‚
â”‚  â”‚    fail   â”€â”€â”€â”˜      â”‚              â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚         â”‚                      â”‚                            â”‚
â”‚         â–¼                      â–¼                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Courier Service (Daemon)                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚   â”‚
â”‚  â”‚  â”‚ Lock Mgr â”‚  â”‚ Archive  â”‚  â”‚  Retry   â”‚          â”‚   â”‚
â”‚  â”‚  â”‚  (claim) â”‚  â”‚  (done)  â”‚  â”‚  (fail)  â”‚          â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç›¸å…³æ–‡æ¡£

- [01_Architecture](01_Architecture.md) - æ•´ä½“æ¶æ„è®¾è®¡
- [02_Mailbox_Protocol](02_Mailbox_Protocol.md) - Mail åè®® Schema è§„èŒƒ
- [03_Mailbox_CLI](03_Mailbox_CLI.md) - Mailbox CLI å‘½ä»¤è®¾è®¡
- [04_Courier_Service](04_Courier_Service.md) - Courier æœåŠ¡æ¶æ„è®¾è®¡
