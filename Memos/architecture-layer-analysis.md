# æ¶æ„åˆ†å±‚é—®é¢˜åˆ†ææŠ¥å‘Š

> **Context**: Architecture Layer Analysis  
> **Date**: 2026-02-03  
> **Author**: Agent (Kimi CLI)  

---

## æ‰§è¡Œæ‘˜è¦

ç”¨æˆ·æå‡ºçš„ä¸‰å±‚æ¶æ„åœ¨å½“å‰ä»£ç ä¸­**å¹¶æœªæ¸…æ™°ä½“ç°**ï¼š

| å±‚çº§ | ç”¨æˆ·æœŸæœ› | å½“å‰ç°çŠ¶ | é—®é¢˜ä¸¥é‡ç¨‹åº¦ |
|------|----------|----------|--------------|
| **Layer 1**: æ–‡ä»¶ç›‘å¬ â†’ äº‹ä»¶ | ç‹¬ç«‹ã€å¯å¤ç”¨ | ä¸ Scheduler è€¦åˆ | ğŸ”´ ä¸¥é‡ |
| **Layer 2**: äº‹ä»¶ç›‘å¬ â†’ è°ƒåº¦ | ç»Ÿä¸€è°ƒåº¦ä¸­å¿ƒ | Handler ç›´æ¥ spawn Agent | ğŸ”´ ä¸¥é‡ |
| **Layer 3**: å…·ä½“æ‰§è¡Œ | å¯æ’æ‹”çš„ Action | åªæœ‰ Agent spawnï¼Œç¼ºå°‘å…¶ä»– Action | ğŸŸ¡ ä¸­ç­‰ |

**æ ¸å¿ƒé—®é¢˜**: å½“å‰æ¶æ„æ˜¯"åŒå±‚"è€Œé"ä¸‰å±‚"ï¼Œæ–‡ä»¶ç›‘å¬ä¸äº‹ä»¶ç”Ÿäº§è€¦åˆï¼Œäº‹ä»¶æ¶ˆè´¹ä¸å…·ä½“æ‰§è¡Œè€¦åˆã€‚

---

## ä¸€ã€ç”¨æˆ·æœŸæœ›çš„ä¸‰å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           LAYER 1: æ–‡ä»¶ç›‘å¬å±‚                            â”‚
â”‚                          (File Watcher / Producer)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ IssueWatcherâ”‚  â”‚ MemoWatcher â”‚  â”‚ TaskWatcher â”‚  â”‚ DropzoneWatcher â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                â”‚                â”‚                  â”‚          â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                   â”‚                                     â”‚
â”‚                                   â–¼                                     â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚                         â”‚   EventBus      â”‚                             â”‚
â”‚                         â”‚  (publish)      â”‚                             â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           LAYER 2: äº‹ä»¶è°ƒåº¦å±‚                            â”‚
â”‚                     (Event Consumer / Action Router)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚                         â”‚  ActionRouter   â”‚                             â”‚
â”‚                         â”‚                 â”‚
â”‚                         â”‚  - ç›‘å¬äº‹ä»¶      â”‚                             â”‚
â”‚                         â”‚  - è·¯ç”±åˆ° Action â”‚                             â”‚
â”‚                         â”‚  - æ¡ä»¶åˆ¤æ–­      â”‚                             â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                                  â”‚                                      â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚         â”‚                        â”‚                        â”‚             â”‚
â”‚         â–¼                        â–¼                        â–¼             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚SpawnAgent   â”‚        â”‚RunPytest    â”‚        â”‚SendNotification â”‚     â”‚
â”‚  â”‚  Action     â”‚        â”‚  Action     â”‚        â”‚    Action       â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                      â”‚                        â”‚
          â–¼                      â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           LAYER 3: æ‰§è¡Œå±‚                                â”‚
â”‚                        (Action Executor)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  AgentScheduler â”‚  â”‚  TestRunner     â”‚  â”‚  NotificationService    â”‚  â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                         â”‚  â”‚
â”‚  â”‚  - spawn agent  â”‚  â”‚  - pytest       â”‚  â”‚  - send IM message      â”‚  â”‚
â”‚  â”‚  - monitor      â”‚  â”‚  - git push     â”‚  â”‚  - send email           â”‚  â”‚
â”‚  â”‚  - terminate    â”‚  â”‚  - deploy       â”‚  â”‚  - webhook              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€å½“å‰æ¶æ„çš„çœŸå®çŠ¶æ€

### 2.1 å®é™…æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å½“å‰æ¶æ„ï¼ˆé—®é¢˜ç‰ˆï¼‰                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    SchedulerService                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚_memo_watcherâ”‚  â”‚_issue_watcherâ”‚  â”‚    _session_monitor     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚   _loop()   â”‚  â”‚   _loop()   â”‚  â”‚        _loop()          â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚         â”‚                â”‚                      â”‚                â”‚   â”‚
â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚   â”‚
â”‚  â”‚                            â”‚                                     â”‚   â”‚
â”‚  â”‚                            â–¼                                     â”‚   â”‚
â”‚  â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚   â”‚
â”‚  â”‚                   â”‚    EventBus     â”‚                            â”‚   â”‚
â”‚  â”‚                   â”‚   (publish)     â”‚                            â”‚   â”‚
â”‚  â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                    â”‚
â”‚                                    â–¼                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      Event Handlers                              â”‚   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ ArchitectHandlerâ”‚    â”‚ EngineerHandler â”‚    â”‚CoronerHandlerâ”‚  â”‚   â”‚
â”‚  â”‚  â”‚                 â”‚    â”‚                 â”‚    â”‚             â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ ç›´æ¥ spawn agent â”‚    â”‚ ç›´æ¥ spawn agent â”‚    â”‚ ç›´æ¥è§¦å‘ apoptosisâ”‚  â”‚   â”‚
â”‚  â”‚  â”‚                 â”‚    â”‚                 â”‚    â”‚             â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ âŒ æ²¡æœ‰ç»Ÿä¸€ Action â”‚    â”‚ âŒ æ²¡æœ‰ç»Ÿä¸€ Action â”‚    â”‚ âŒ æ²¡æœ‰ç»Ÿä¸€ Actionâ”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                    â”‚
â”‚                                    â–¼                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    SessionManager + Worker                        â”‚   â”‚
â”‚  â”‚                      (ç›´æ¥ subprocess.Popen)                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  ğŸ”´ é—®é¢˜ï¼š                                                              â”‚
â”‚  1. æ–‡ä»¶ç›‘å¬ä¸ SchedulerService è€¦åˆ                                    â”‚
â”‚  2. Handler ç›´æ¥ spawn agentï¼Œæ²¡æœ‰ Action æŠ½è±¡                          â”‚
â”‚  3. æ²¡æœ‰ pytestã€git pushã€IM ç­‰å…¶ä»– Action çš„æ‰©å±•æœºåˆ¶                   â”‚
â”‚  4. æ–°å¢ Action éœ€è¦ä¿®æ”¹ Handler ä»£ç                                    â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ä»£ç å±‚é¢çš„é—®é¢˜è¯æ®

#### é—®é¢˜ 1: æ–‡ä»¶ç›‘å¬ä¸äº‹ä»¶ç”Ÿäº§è€¦åˆ

```python
# monoco/daemon/scheduler.py:157-199
class SchedulerService:
    async def _memo_watcher_loop(self):
        """Watch for memo changes and emit MEMO_THRESHOLD events."""
        while self._running:
            await self._check_memo_thresholds()  # ç›´æ¥è°ƒç”¨
            await asyncio.sleep(self.MEMO_CHECK_INTERVAL)
    
    async def _check_memo_thresholds(self):
        """Check memo counts and emit threshold events."""
        for project_ctx in self.project_manager.projects.values():
            memos = load_memos(issues_root)  # ç›´æ¥è¯»å–æ–‡ä»¶
            pending_count = len([m for m in memos if m.status == "pending"])
            
            if prev_count < threshold <= pending_count:
                await event_bus.publish(...)  # ç›´æ¥ç”Ÿäº§äº‹ä»¶
```

**é—®é¢˜**: 
- `SchedulerService` æ—¢è´Ÿè´£**è°ƒåº¦**åˆè´Ÿè´£**æ–‡ä»¶ç›‘å¬**
- è¿åå•ä¸€èŒè´£åŸåˆ™
- æ— æ³•ç‹¬ç«‹å¤ç”¨æ–‡ä»¶ç›‘å¬é€»è¾‘

#### é—®é¢˜ 2: Handler ç›´æ¥æ‰§è¡Œï¼Œæ²¡æœ‰ Action æŠ½è±¡

```python
# monoco/daemon/handlers.py:86-113
class ArchitectHandler(AgentEventHandler):
    async def handle(self, event: AgentEvent):
        """Spawn Architect agent."""
        # âŒ ç›´æ¥åˆ›å»º RoleTemplate
        role = RoleTemplate(
            name="Architect",
            description="System Architect",
            trigger="memo.accumulation",
            goal="Process memo inbox and create issues.",
            system_prompt="You are the Architect...",
            engine="gemini"
        )
        
        # âŒ ç›´æ¥è°ƒç”¨ SessionManager
        session = self.session_manager.create_session(
            issue_id="architecture-review",
            role=role
        )
        
        # âŒ ç›´æ¥å¯åŠ¨
        session.start()
```

**é—®é¢˜**:
- Handler ç›´æ¥çŸ¥é“å¦‚ä½• spawn agent
- æ²¡æœ‰ `Action` æŠ½è±¡å±‚
- æ— æ³•æ‰©å±•ä¸ºå…¶ä»– Actionï¼ˆå¦‚ pytestã€git pushï¼‰

#### é—®é¢˜ 3: ç¼ºå°‘å…¶ä»– Action ç±»å‹

æœç´¢æ•´ä¸ªä»£ç åº“ï¼Œ**æ²¡æœ‰å‘ç°**ä»¥ä¸‹ Action çš„å®ç°ï¼š

| Action ç±»å‹ | å­˜åœ¨ï¼Ÿ | ä½ç½® |
|-------------|--------|------|
| Spawn Agent | âœ… | `handlers.py` (ç¡¬ç¼–ç ) |
| Run Pytest | âŒ | æ—  |
| Git Push | âŒ | æ—  |
| Send IM | âŒ | æ—  |
| Send Email | âŒ | æ—  |
| Webhook | âŒ | æ—  |

---

## ä¸‰ã€ä¸‰å±‚æ¶æ„çš„ç¼ºå¤±åˆ†æ

### 3.1 Layer 1: æ–‡ä»¶ç›‘å¬å±‚ - ç¼ºå¤±ç‹¬ç«‹æŠ½è±¡

**å½“å‰**: `SchedulerService` å†…éƒ¨ç›´æ¥å®ç°è½®è¯¢

```python
# å½“å‰ï¼šè€¦åˆåœ¨ SchedulerService ä¸­
class SchedulerService:
    async def _memo_watcher_loop(self): ...
    async def _issue_watcher_loop(self): ...
```

**åº”è¯¥**: ç‹¬ç«‹çš„ Watcher ç»„ä»¶ï¼Œé€šè¿‡ EventBus è§£è€¦

```python
# æœŸæœ›ï¼šç‹¬ç«‹çš„æ–‡ä»¶ç›‘å¬å±‚
class FilesystemWatcher(ABC):
    """Layer 1: æ–‡ä»¶ç›‘å¬æŠ½è±¡"""
    
    @abstractmethod
    async def watch(self) -> AsyncIterator[FileEvent]: ...

class IssueWatcher(FilesystemWatcher):
    """ç›‘å¬ Issue æ–‡ä»¶å˜åŒ–"""
    pass

class MemoWatcher(FilesystemWatcher):
    """ç›‘å¬ Memo æ–‡ä»¶å˜åŒ–"""
    pass
```

### 3.2 Layer 2: äº‹ä»¶è°ƒåº¦å±‚ - ç¼ºå¤± ActionRouter

**å½“å‰**: Handler ç›´æ¥æ‰§è¡Œ

```python
# å½“å‰ï¼šHandler ç›´æ¥ spawn agent
class ArchitectHandler(AgentEventHandler):
    async def handle(self, event):
        session = self.session_manager.create_session(...)  # ç›´æ¥æ‰§è¡Œ
        session.start()
```

**åº”è¯¥**: ActionRouter è·¯ç”±åˆ°å…·ä½“ Action

```python
# æœŸæœ›ï¼šActionRouter å±‚
class ActionRouter:
    """Layer 2: äº‹ä»¶è°ƒåº¦ä¸­å¿ƒ"""
    
    def __init__(self):
        self._actions: Dict[str, Action] = {}
    
    def register_action(self, event_type: str, action: Action):
        self._actions[event_type] = action
    
    async def route(self, event: AgentEvent):
        action = self._actions.get(event.type)
        if action:
            await action.execute(event.payload)

class Action(ABC):
    """Action æŠ½è±¡"""
    @abstractmethod
    async def execute(self, payload: Dict) -> ActionResult: ...
```

### 3.3 Layer 3: æ‰§è¡Œå±‚ - ç¼ºå¤±å¤šç§ Action å®ç°

**å½“å‰**: åªæœ‰ Agent spawn

```python
# å½“å‰ï¼šåªæœ‰è¿™ä¸€ç§"æ‰§è¡Œ"
session_manager.create_session(...)
```

**åº”è¯¥**: å¤šç§å¯æ’æ‹”çš„ Action å®ç°

```python
# æœŸæœ›ï¼šå¤šç§ Action å®ç°
class SpawnAgentAction(Action):
    """æ‰§è¡Œï¼šå¯åŠ¨ Agent"""
    async def execute(self, payload):
        return await self.scheduler.schedule(task)

class RunPytestAction(Action):
    """æ‰§è¡Œï¼šè¿è¡Œæµ‹è¯•"""
    async def execute(self, payload):
        return await subprocess.run(["pytest", ...])

class SendIMAction(Action):
    """æ‰§è¡Œï¼šå‘é€ IM æ¶ˆæ¯"""
    async def execute(self, payload):
        return await self.im_client.send_message(...)

class GitPushAction(Action):
    """æ‰§è¡Œï¼šGit æ¨é€"""
    async def execute(self, payload):
        return await subprocess.run(["git", "push", ...])
```

---

## å››ã€é‡æ„å»ºè®®

### 4.1 ç›®æ ‡æ¶æ„

```
monoco/
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ watcher/              # Layer 1: æ–‡ä»¶ç›‘å¬å±‚
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ base.py           # FilesystemWatcher ABC
â”‚   â”‚   â”œâ”€â”€ issue_watcher.py
â”‚   â”‚   â”œâ”€â”€ memo_watcher.py
â”‚   â”‚   â””â”€â”€ task_watcher.py
â”‚   â”‚
â”‚   â”œâ”€â”€ router/               # Layer 2: äº‹ä»¶è°ƒåº¦å±‚
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ router.py         # ActionRouter
â”‚   â”‚   â””â”€â”€ action.py         # Action ABC
â”‚   â”‚
â”‚   â””â”€â”€ executor/             # Layer 3: æ‰§è¡Œå±‚
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ base.py           # Action åŸºç±»
â”‚       â”œâ”€â”€ agent_action.py   # SpawnAgentAction
â”‚       â”œâ”€â”€ pytest_action.py  # RunPytestAction
â”‚       â”œâ”€â”€ git_action.py     # GitPushAction
â”‚       â””â”€â”€ im_action.py      # SendIMAction
â”‚
â””â”€â”€ daemon/
    â””â”€â”€ app.py                # ç»„è£…æ‰€æœ‰å±‚
```

### 4.2 å…³é”®æ¥å£å®šä¹‰

```python
# core/watcher/base.py
class FilesystemWatcher(ABC):
    """Layer 1: æ–‡ä»¶ç›‘å¬æŠ½è±¡"""
    
    def __init__(self, event_bus: EventBus):
        self.event_bus = event_bus
    
    @abstractmethod
    async def start(self): ...
    
    @abstractmethod
    async def stop(self): ...
    
    async def emit(self, event_type: str, payload: Dict):
        await self.event_bus.publish(event_type, payload)

# core/router/action.py  
class Action(ABC):
    """Layer 2 & 3: Action æŠ½è±¡"""
    
    @property
    @abstractmethod
    def name(self) -> str: ...
    
    @abstractmethod
    async def can_execute(self, payload: Dict) -> bool:
        """æ£€æŸ¥æ˜¯å¦å¯ä»¥æ‰§è¡Œï¼ˆæ¡ä»¶åˆ¤æ–­ï¼‰"""
        pass
    
    @abstractmethod
    async def execute(self, payload: Dict) -> ActionResult:
        """æ‰§è¡Œ Action"""
        pass

class ActionResult:
    success: bool
    output: str
    error: Optional[str]
    metadata: Dict

# core/router/router.py
class ActionRouter:
    """Layer 2: äº‹ä»¶è·¯ç”±ä¸­å¿ƒ"""
    
    def __init__(self, event_bus: EventBus):
        self.event_bus = event_bus
        self._actions: Dict[str, List[Action]] = defaultdict(list)
        self._running = False
    
    def register(self, event_type: str, action: Action):
        """æ³¨å†Œ Action åˆ°ç‰¹å®šäº‹ä»¶"""
        self._actions[event_type].append(action)
    
    async def start(self):
        """å¼€å§‹ç›‘å¬äº‹ä»¶å¹¶è·¯ç”±"""
        self._running = True
        while self._running:
            event = await self.event_bus.consume()
            await self._route(event)
    
    async def _route(self, event: AgentEvent):
        """è·¯ç”±äº‹ä»¶åˆ°å¯¹åº” Actions"""
        actions = self._actions.get(event.type, [])
        for action in actions:
            if await action.can_execute(event.payload):
                result = await action.execute(event.payload)
                # å¯ä»¥åœ¨è¿™é‡Œå¤„ç†ç»“æœï¼Œå¦‚è®°å½•æ—¥å¿—ã€è§¦å‘æ–°äº‹ä»¶ç­‰
```

### 4.3 ä½¿ç”¨ç¤ºä¾‹

```python
# daemon/app.py - ç»„è£…ä¸‰å±‚æ¶æ„
async def lifespan(app: FastAPI):
    # Layer 1: å¯åŠ¨æ–‡ä»¶ç›‘å¬
    watchers = [
        IssueWatcher(event_bus),
        MemoWatcher(event_bus),
        TaskWatcher(event_bus),
    ]
    for watcher in watchers:
        await watcher.start()
    
    # Layer 2: é…ç½® ActionRouter
    router = ActionRouter(event_bus)
    
    # Layer 3: æ³¨å†Œå„ç§ Actions
    router.register("ISSUE_STAGE_CHANGED", SpawnAgentAction(
        scheduler=agent_scheduler,
        role="Engineer"
    ))
    router.register("MEMO_THRESHOLD", SpawnAgentAction(
        scheduler=agent_scheduler,
        role="Architect"
    ))
    router.register("PR_CREATED", RunPytestAction())
    router.register("PR_CREATED", SendIMAction(
        channel="#dev"
    ))
    
    await router.start()
    
    yield
    
    # æ¸…ç†
    await router.stop()
    for watcher in watchers:
        await watcher.stop()
```

---

## äº”ã€ç»“è®º

### 5.1 å½“å‰æ¶æ„è¯„ä¼°

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| **åˆ†å±‚æ¸…æ™°** | 3/10 | æ–‡ä»¶ç›‘å¬ä¸è°ƒåº¦è€¦åˆï¼Œç¼ºå°‘ Action æŠ½è±¡ |
| **æ‰©å±•æ€§** | 4/10 | æ–°å¢ Action éœ€è¦ä¿®æ”¹ Handler ä»£ç  |
| **å¯æµ‹è¯•æ€§** | 5/10 | å„å±‚è€¦åˆå¯¼è‡´å•å…ƒæµ‹è¯•å›°éš¾ |
| **å¯ç»´æŠ¤æ€§** | 4/10 | èŒè´£ä¸æ¸…ï¼Œä»£ç åˆ†æ•£ |

### 5.2 å…³é”®é—®é¢˜æ€»ç»“

1. **æ²¡æœ‰æ¸…æ™°çš„ Layer 1**: æ–‡ä»¶ç›‘å¬é€»è¾‘æ•£è½åœ¨ `SchedulerService` ä¸­
2. **æ²¡æœ‰ Layer 2 (Router)**: Handler ç›´æ¥æ‰§è¡Œï¼Œç¼ºå°‘è·¯ç”±å±‚
3. **Layer 3 ä¸å®Œæ•´**: åªæœ‰ Agent spawnï¼Œç¼ºå°‘ pytestã€gitã€IM ç­‰ Action

### 5.3 å»ºè®®ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | ä»»åŠ¡ | å½±å“ |
|--------|------|------|
| **P0** | æå–æ–‡ä»¶ç›‘å¬åˆ°ç‹¬ç«‹æ¨¡å— | è§£è€¦ Layer 1 |
| **P0** | è®¾è®¡ Action æŠ½è±¡å’Œ Router | å»ºç«‹ Layer 2 & 3 |
| **P1** | å®ç°å¤šç§ Action ç±»å‹ | å®Œå–„ Layer 3 |
| **P2** | é‡æ„ç°æœ‰ Handler ä¸º Action | è¿ç§»åˆ°æ–°æ¨¡å¼ |

---

*Report Generated: 2026-02-03*
