---
id: FEAT-0168
uid: 6c8e9e
type: feature
status: open
stage: draft
title: 飞书平台适配器：事件接收与消息发送
created_at: '2026-02-03T23:23:33'
updated_at: '2026-02-03T23:23:33'
parent: EPIC-0033
dependencies:
- FEAT-0167
domains:
- CollaborationBus
tags:
- '#EPIC-0033'
- '#FEAT-0167'
- '#FEAT-0168'
files: []
criticality: high
solution: null # implemented, cancelled, wontfix, duplicate
opened_at: '2026-02-03T23:23:33'
---

## FEAT-0168: 飞书平台适配器：事件接收与消息发送

## Objective
实现飞书 (Lark) 平台的完整适配器，支持事件订阅接收、消息发送和富媒体处理。

### 集成范围
- **事件订阅**: 使用飞书 Event Webhook 接收消息
- **消息发送**: 使用飞书 Bot API 发送文本/卡片/图片
- **身份验证**: 支持 Encrypt Key 和 Verification Token
- **富媒体**: 支持图片、文件、交互式卡片

## Acceptance Criteria
- [ ] 实现飞书事件 Webhook 接收端点
- [ ] 实现消息解析（文本、图片、@提及）
- [ ] 实现消息发送（文本、Markdown、卡片）
- [ ] 实现流式消息更新（长文本分片）
- [ ] 支持加密验证（Encrypt Key）
- [ ] 支持多租户（多个飞书企业）

## Technical Tasks
- [ ] 创建 `monoco/features/im/platforms/base.py`
  - [ ] `PlatformAdapter` 抽象基类
  - [ ] `parse_event()` 方法
  - [ ] `send_message()` 方法
  - [ ] `send_streaming()` 方法
- [ ] 创建 `monoco/features/im/platforms/feishu.py`
  - [ ] `FeishuAdapter` 实现
  - [ ] 事件签名验证
  - [ ] 消息格式转换（飞书 → IMMessage）
  - [ ] 卡片消息构建器
- [ ] 创建 Webhook 端点 `/api/v1/im/webhook/feishu`
  - [ ] 挑战验证（URL 验证）
  - [ ] 事件分发
  - [ ] 错误处理
- [ ] 实现飞书 API 客户端
  - [ ] 获取 tenant_access_token
  - [ ] 发送普通消息
  - [ ] 发送卡片消息
  - [ ] 更新已发送消息（用于流式）
- [ ] 飞书特有功能
  - [ ] 线程消息（Reply）
  - [ ] 富文本（Post 类型）
  - [ ] 交互式卡片回调
  - [ ] 用户/群组信息查询

## API 集成清单
- [ ] **事件订阅**
  - `im.message.receive_v1` - 接收消息
  - `im.message.reaction.created_v1` - 表情回应
- [ ] **消息发送**
  - `POST /open-apis/im/v1/messages` - 发送消息
  - `PATCH /open-apis/im/v1/messages/{message_id}` - 更新消息
- [ ] **资源获取**
  - `GET /open-apis/im/v1/chats/{chat_id}` - 群组信息
  - `GET /open-apis/contact/v3/users/{user_id}` - 用户信息

## Configuration
```yaml
# project.yaml
im:
  feishu:
    app_id: "cli_xxxxxxxx"
    app_secret: "encrypted:..."
    encrypt_key: "encrypted:..."
    verification_token: "..."
    event_types:
      - "im.message.receive_v1"
```

## Review Comments
