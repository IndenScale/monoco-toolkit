## Ralph Loop

> **重生后接力胜过泥泞中挣扎。**

当当前 Agent 遇到瓶颈（上下文不足、陷入局部最优、需要全新视角）时，启动继任 Agent 继续完成 Issue。

## 核心概念

- **Last Words** - 当前 Agent 留给继任者的关键信息：已完成的工作、当前状态、下一步建议
- **接力而非重启** - 继任者继承 Issue 上下文和工作环境，而不是从零开始
- **自愿让贤** - 当当前 Agent 判断自己效率下降时主动触发，而非强行坚持

## 命令

- `monoco ralph --issue {issue-id} --prompt "{last-words}"` - 直接传递遗言字符串
- `monoco ralph --issue {issue-id} --path {last-words-file}` - 从文件读取遗言（用于长内容）
- `monoco ralph --issue {issue-id}` - 让系统自动生成上下文摘要作为 Last Words

## 自动触发机制

Ralph Loop 会在以下任一条件满足时自动触发（无需人工干预）：

### 工具调用计数

| 阈值 | 行为 |
|------|------|
| **150 次** | 警告：提示上下文已使用约 75%，建议准备收尾 |
| **175 次** | 严重警告：提示上下文已使用约 87.5%，强烈建议完成当前里程碑或准备接力 |
| **200 次** | **强制接力**：自动启动 `monoco ralph`，当前 Agent 结束会话 |

### 内容长度累计

基于响应内容字符数统计（1 token ≈ 4 字符）：

| 阈值 | 行为 |
|------|------|
| **300k 字符** (~75k tokens) | 警告：建议准备收尾 |
| **350k 字符** (~87.5k tokens) | 严重警告：建议尽快完成或接力 |
| **400k 字符** (~100k tokens) | **强制接力**：自动启动 `monoco ralph` |

### 触发范围

**工具调用计数**追踪以下工具：
- `Bash`, `Write`, `Edit`, `Read`
- `Glob`, `Grep`, `Task`
- `WebFetch`, `WebSearch`

**内容长度**统计以下工具的响应：
- `Read`, `Glob`, `Grep`
- `WebFetch`, `WebSearch`

### 跳过机制

如需临时禁用自动触发（例如正在进行关键原子操作）：

```bash
export MONOCO_SKIP_RALPH=1
```

设置后，即使达到阈值也不会强制接力。

## 工作流

1. **自我评估**：当前 Agent 判断是否遇到瓶颈
   - 上下文窗口即将用尽（自动触发机制会处理）
   - 多次尝试同一问题无果
   - 感觉陷入细节而迷失全局

2. **撰写 Last Words**：总结关键信息
   - ✅ 已完成的工作和验证结果
   - ✅ 当前代码/文件状态
   - ✅ 遇到的障碍或不确定的问题
   - ✅ 建议的下一步方向

3. **执行接力**：运行 `monoco ralph` 启动继任 Agent

4. **平滑过渡**：继任 Agent 读取 Last Words 和 Issue 上下文，继续推进

## 指南

### 何时使用 Ralph

| 适合使用 | 不适合使用 |
|---------|-----------|
| 复杂重构涉及大量文件 | 简单的 bug 修复 |
| 上下文窗口不足（自动触发） | 单文件修改 |
| 多次尝试无果，需要新视角 | 已经接近完成，只剩收尾 |
| 陷入技术细节需要全局审视 | 验证性测试 |

### Last Words 最佳实践

- **简明扼要**：聚焦关键信息，而非完整历史
- **状态优先**：描述"现在在哪里"而非"怎么来的"
- **方向明确**：给继任者一个清晰的下一步建议
- **诚实记录**：不隐瞒失败尝试，避免继任者重复踩坑

### 接力后

- 当前 Agent 正常结束会话
- 继任 Agent 在独立环境中启动，继承 Issue 上下文
- 无需手动同步文件，`monoco ralph` 会自动处理
